---
title: "Mutation by strain table "
output: html_notebook
editor_options: 
  chunk_output_type: inline
---
My goal here is to organize the breseq data in a t table with genes as rows and the strains as columns. Table cells will contain nubers indicating the nuber of mutations observed.


```{r, message=FALSE}
rm(list=ls())
library(tidyverse, quietly = TRUE)
library(cowplot, quietly = TRUE)
library(viridis)
```
## Loading strain data  
* trt: phage infection  
* lim: limiting nutrient  
* cID: chemostat number  
* time: sampling time in days  
* strain_ID: sample day + chemostat + strain number  

```{r, message=FALSE}
# table of strains and their source (time, treatment)
strains <- read_csv("../data/strains.csv")
# remove ansector
strains <- filter(strains,strain_ID!="WH7803")
strains
```  

# Mutation data  
I copy pasted the data found in _data/20140611_allcompare.html_ into excel and cleaned it up a bit. Re-importing it preserved some of the charachters that were lost in the file as it is found in _data/breseq.compare.csv_.  
* I removed the first line that indicates a complete genome deletion. This results in strain 03N1S1 not having any mutation. this caused a bunch of NA being put in cells upon import, so I put in 0s instead.   
* I cleaned all the special charechters out of the mutation column. the right pointing arrow I replaced with "sub", $\Delta$ was replaced by "d", and a bunch of spces that acted funny upon import were changed to regular spaces.  
* Cleaning the anotation data from special charecters is too much of a mess. Instead I downloaded a table of the genetic features of WH7803 from <ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/063/505/GCA_000063505.1_ASM6350v1/GCA_000063505.1_ASM6350v1_feature_table.txt.gz>. I verified that the positions are similar to what is in the breseq html file in a few loci. seems like a perfect fit. This too required some cleanin to remove the duplicated rows and some empty columns.  
* replaced empty cells, "?", $\Delta$  with "0"; replaced "100%" with 1.  

```{r, message=FALSE}
# Import data file
breseq <- read_csv("breseq_allcompare.csv")

# correct column names
colnames (breseq)<- gsub(".g","",colnames (breseq))

```

# Summarizing mutations by gene  

```{r}


# # crop out the annotation data
# breseq.annot  <-  
#   breseq%>%
#     select(position,mutation,annotation,gene,description)


#summarize mutations by gene
mXg <- 
  breseq%>%
    select(-position,-mutation,-annotation)%>%
    group_by(gene, description)%>%
    summarize_if(is.numeric, sum, na.rm = TRUE)
   
write_csv(mXg, "mxg.csv")
knitr::kable(mXg)

```

## summarize by treatment  
Consolidate columns (strains) that have the come from the same treaatment (nutrient and phage)
```{r}
# test for compatability between strain and mutation tables

# strain names from mutation data
breseq.strains <- 
  breseq%>%
  select_if(is.numeric)%>%
  select(-position)%>%
  colnames()

# sum(!(breseq.strains %in% strains$strain_ID)) #0
# sum(!(strains$strain_ID %in% breseq.strains)) #0
# # the lists match!
trtXg <- 
#transpose the table 
mXg %>%
  select(-description)%>%
  pivot_longer( cols = c(2:ncol(.)),names_to = "strain_ID", values_to = "mutations")%>%
  pivot_wider(id_cols = strain_ID, names_from = "gene", values_from = "mutations")%>%
  # add the meta data
  left_join(select(strains,trt, lim, strain_ID), . )%>%
  #summarize treatments
  group_by(trt, lim)%>%
  mutate(n.strains=n())%>%
  group_by(trt, lim,n.strains)%>%
  summarize_if(is_double, sum, na.rm = TRUE)%>%
  # transpose back
  mutate(meta=paste0(lim,".",trt,".","n", n.strains))%>%
  ungroup()%>%
  select(-trt, -lim, -n.strains)%>%
  pivot_longer( cols = c(1:(ncol(.)-1)),names_to = "gene", values_to = "mutations")%>%
  pivot_wider(id_cols = gene, names_from = "meta", values_from = "mutations")

trtXg$gene <- str_replace_all(trtXg$gene, "[^[:alnum:],_,/]", "")
trtXg
```

```{r}
#To normalize mutations I want number of strains
n.strains <- 
  mXg %>%
    select(-description)%>%
    pivot_longer( cols = c(2:ncol(.)),names_to = "strain_ID", values_to = "mutations")%>%
    pivot_wider(id_cols = strain_ID, names_from = "gene", values_from = "mutations")%>%
    # add the meta data
    left_join(select(strains,trt, lim, strain_ID), . )%>%
    #summarize treatments
    group_by(trt, lim)%>%
    mutate(n=n())%>%
    select(trt,lim,n)%>%
    group_by(trt, lim,n)%>%
    summarise()

#normalize
trtXg%>%
  select(-gene)%>%
  sweep(., 2,FUN="/",STATS=n.strains$n)%>%
  #add gene names back
  mutate(gene=trtXg$gene)%>%
  #prepare for plotting
  pivot_longer(cols = colnames(trtXg)[-1], names_to = "trt", values_to = "norm.mut")%>%
  ggplot(aes(x=trt, y=gene,fill=log10(norm.mut)))+
  geom_tile(colour="white",size=0.25)+
  scale_fill_viridis()->p

ggsave("heatmap.pdf",p, height = 10)

p  


```

